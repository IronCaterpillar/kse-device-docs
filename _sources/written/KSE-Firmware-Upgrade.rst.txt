Обновление ПО с помощью KSE Firmware Upgrade
=============================================

Общее описание утилиты KSE Firmware Upgrade
-----------------------

Утилита *KSE Firmware Upgrade* предназначена для обновления встроенного ПО устройства, а так же для манипуляции с файлами настройки, WEB-интерфейса и др.
Утилита поставляется в архиве и не требует установки. Допускается запуск с переносного накопителя.

Подготовка к системы к обновлению ПО
----------------------------------------------

Для обновления ПО устройства используется специальный драйвер *libusb*, который необходимо установить с помощью утилиты *"Zadig"*.

Установка драйвера 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Утилита для установки драйверов *"Zadig"* входит в поставку и находится в папке с *KSE Firmware Upgrade*. 
При необходимости можно скачать наиболее актуальную версию утилиты на сайте `zadig.akeo.ie <https://zadig.akeo.ie/>`_.
Перед запуском утилиты необходимо перевести устройство в режим *DFU*, для чего следует нажать кнопку *Rst* и удерживать её до
включения индикатора *Status*.  Затем следует запустить утилиту.

.. figure:: /img/kse-upgrade/zadig1.png
       :align: center
       :alt: Общий вид утилиты

       Общий вид утилиты

В выпадающем списке следует выбрать устройство *STM32*, в списке драйверов следует выбрать *WinUSB*, либо любой из драйверов семейства *libusb*.
После этого необходимо нажать кнопку *Replace Driver*. В появившемся окне необходимо подтвердить намерение установить новый драйвер.

.. figure:: /img/kse-upgrade/zadig2.png
       :align: center
       :alt: Замена драйвера

       Замена драйвера

Установка драйвера завершена, можно закрыть утилиту и запустить *KSE Firmware Upgrade*.


Работа с утилитой KSE Firmware Upgrade
-----------------------------------------

.. figure:: /img/kse-upgrade/fwu1.png
       :align: center
       :alt: Окно KSE Firmware Upgrade

       Окно KSE Firmware Upgrade

Окно утилиты содержит следующие элементы:

* Индикатор подключения по протоколу TCP/IP, который служит для обновления/чтения содержимого файловой системы устройства
* Индикатор активности режима обновления(*DFU*), который служит для обновления ПО устройства
* Кнопка *Загрузить в устройство*, которая используется для обновления ПО, а так же для обновления содержимого ФС
* Кнопка *Считать из устройства*, которая служит для создания резервной копии ПО, а так же файлов настройки устройства
* Области сообщений
* Меню, дублирующего кнопки управления

Обновление ПО и файлов настройки устройства
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для обновления ПО и/или файлов устройства нажмите кнопку *Загрузить в устройство*. Откроется диалог выбора файлов, где необходимо выбрать нужный файл прошивки,
либо ранее созданный файл резервной копии. После этого откроется окно выбора компонентов для обновления:

.. figure:: /img/kse-upgrade/fwu_load.png
       :align: center
       :alt: Выбор обновляемых компонентов

       Выбор обновляемых компонентов

В открывшемся окне присутствуют следующие компоненты:

* Выбор системного ПО
* Просмотр истории изменений 
* Выбор прикладного ПО
* Выбор файла отображения в адресное пространство протокола *Modbus* (modbus_mappings.cfg)
* Выбор WEB-интерфейса
* Выбор локального интерфейса пользователя
* IP адрес устройства
* Имя пользователя
* Пароль
* Кнопки индивидуального обновления компонентов
* Кнопку общего обновления компонентов
* Кнопку стирания системного ПО
* Кнопку стирания прикладного ПО

.. attention::
   IP адрес, имя пользователя и пароль установлена на значения по умолчанию. Если эти параметры не были изменены, их значения не следует изменять.


При выборе обновления системного и/или прикладного ПО появится окно подтверждения, отображающее параметры установленного и устанавливаемого ПО.

.. figure:: /img/kse-upgrade/fwu_load_question.png
       :align: center
       :alt: Подтверждение обновления ПО

       Подтверждение обновления ПО


После подтверждения в окне приложения отобразится прогресс операции и в области сообщений появятся записи о ходе процесса.

.. figure:: /img/kse-upgrade/fwu_load_bcup.png
       :align: center
       :alt: Ход процесса резервного копирования

       Ход процесса резервного копирования

.. figure:: /img/kse-upgrade/fwu_load_sys.png
       :align: center
       :alt: Ход процесса обновления системного ПО

       Ход процесса обновления системного ПО

.. figure:: /img/kse-upgrade/fwu_load_ftp1.png
       :align: center
       :alt: Ход процесса обновления настроек в ФС

       Ход процесса обновления настроек в ФС
В случае отсутствия сообщений об ошибках, обновление считается завершённым, устройство готово к работе.

