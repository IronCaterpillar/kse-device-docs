Описание работы линии электрообогрева
========================================

Общее описание
---------------------------------
Объект "Линия электрообогрева" присутствует в устройствах, предназначенных для систем электрообогрева. В зависимости от аппаратной конфигурации устройства таких линий может быть разное количество. Принципы управления, контроля и измерения одинаковы для всех линий и устройств. 

Словарь 
---------------------------------
Словарь линии электрообогрева делится на стандартные блоки описания, статуса, управления, измерения и настроек.

Описание работы
-----------------------

.. note:: 
   Линия электрообогрева может быть выведена из работы с помощью параметра "Разрешить ввод в работу". В данном режиме ни управление ни измерения не производятся

Линия электрообогрева управляется в соответствии с выбранным режимом работы и уставками, заданными пользователем. 
При выходе параметров линии за аварийные пределы может осуществляться аварийное отключение линии, при этом повторное включение возможно лишь после квитирования.
Контроль состояния линии может осуществляться посредством дисплея(при наличии), интерфейсов связи и выходов "Alarm"(при наличии).
.. attention::
   Контроль параметров линии и вывод аварий осуществляется во всех режимах
В случае обнаружения ошибки в настройках линия отключается и выставляется флаг "Неправильная конфигурация". 

Вычисление температуры процесса
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Для работы в режимах, где управление ведётся по температуре вводится понятие *температура* *процесса*. 
В качестве *температуры* *процесса* можно использовать как данные с датчика температуры, так и вычисленное значение.

Режимы вычисления *температуры* *процесса*: 

* По одному из датчиков: температура берётся с одного из внешних датчиков.
* По среднему: за температуру процесса принимается среднее арифметическое температур, полученных с датчиков.
* По минимуму: за температуру процесса принимается минимальная из температур, полученных с внешних датчиков.
* По максимуму: за температуру процесса принимается максимальная из температур, полученных с датчиков.

Режимы работы 
~~~~~~~~~~~~~~~~~


.. Линия электрообогрева может работать в следующих режимах:

   .. table:: Режимы работы линии электрообогрева
      +--------------------------------------------+------------+
      | Режим                                      | Код режима |
      +============================================+============+
      | Линия постоянно выключена                  | 0          |
      +--------------------------------------------+------------+
      | Линия постоянно включена                   | 1          |
      +--------------------------------------------+------------+
      | Дистанционное управление линией            | 2          |
      +--------------------------------------------+------------+
      | Режим ШИМ(т.н. Duty)                       | 3          |
      +--------------------------------------------+------------+
      | Релейный(Двухпозиционный) по температуре   | 4          |
      +--------------------------------------------+------------+
      | Режим пропорционального ШИМ по температуре | 5          |
      +--------------------------------------------+------------+
  

Линия постоянно выключена
""""""""""""""""""""""""""""
В данном режиме выход линии постоянно отключен. Измерения выполняются штатно.

Линия постоянно включена
""""""""""""""""""""""""""""""
В данном режиме выход линии постоянно включен. Измерения выполняются штатно.

Дистанционное управление линией
""""""""""""""""""""""""""""""""""""

В данном режиме управление линией происходит посредством интерфейсов связи. Конкретные интерфейсы зависят от типа устройства.

Режим ШИМ
""""""""""""""""""""""""""""
В данном режиме происходит периодическое включение и отключение выхода линии. Период режима ШИМ задаётся в секундах, длительность включенного состояния выхода задаётся в процентах от периода.

Релейный режим
"""""""""""""""""""""""""""""

В релейном режиме устройство поддерживает заданную пользователем температуру объекта путём включения/отключения электрообогрева. 
`Вычисление температуры процесса`_ ведётся в соответствии с настройками.
Уставка желаемой температуры задаётся в градусах, так же настраивается зона нечувствительности в положительном и отрицательном направлении. 
Включение производится, когда линия остывает ниже температуры уставки за вычетом отрицательного гистерезиса, отключение же производится, когда температура превысит уставку плюс положительный гистерезис.

.. plot:: ./ellipses.py
   :include-source:

Пропорциональный ШИМ
""""""""""""""""""""""""""""""""""

В режиме пропорционального ШИМ значение Duty-цикла интерполируется между двумя точками, заданными пользователем. Интерполяция выполняется на основе *температуры процесса* 
(см. `Вычисление температуры процесса`_). Интерполяция линейная, ведётся по двум точкам. Названия точек соответствуют температуре, т.е. нижняя точка - точка с более низкой температурой.

* В нижней точке уставки задаётся температура и Duty-цикл; ниже температуры, заданной в этой точке, значение Duty-цикла будет **постоянно и соответствовать нижней уставке**; 
* В верхней точке уставки задаётся температура и Duty-цикл; выше температуры, заданной в этой точке, значение Duty-цикла будет нулевым и линия будет **выключена**;

.. jupyter-execute::
   :hide-code:

   %matplotlib inline
   import numpy as np
   import matplotlib.pyplot as plt
   fig, ax = plt.subplots(figsize=(10, 10))
   t = np.array([-40,-30,-30,5,5,10])
   pwm = np.array([90,90,90,5,0,0])
   # Plot a line and add some simple annotations
   line, = ax.plot(t, pwm)
   #ax.annotate('Пропорциональный ШИМ',
   #            xy=(.025, .975), xycoords='figure fraction',
   #            horizontalalignment='left', verticalalignment='top',
   #            fontsize=20)
   # The following examples show off how these arrows are drawn.
   ax.set_xlabel("Темпреатура, °С")
   ax.set_ylabel("Duty-цикл ШИМ, %")
   ax.annotate('Нижняя\n уставка',
               xy=(-30, 90), xycoords='data',
               xytext=(20, -60), textcoords='offset points',
               arrowprops=dict(facecolor='black',  arrowstyle="->"),
               horizontalalignment='right', verticalalignment='top')
   ax.annotate('Верхняя\n уставка',
               xy=(5, 5), xycoords='data',
               xytext=(0.8, 0.95), textcoords='axes fraction',
               arrowprops=dict(facecolor='black',  arrowstyle="->"),
               horizontalalignment='right', verticalalignment='top')
   # You may also use negative points or pixels to specify from (right, top).
   # E.g., (-10, 10) is 10 points to the left of the right side of the axes and 10
   # points above the bottom
   #ax.set(xlim=(-40, 20), ylim=(-5, 105))
   ax.grid()
   pass

Аварийное отключение
~~~~~~~~~~~~~~~~~~~~~~~~

Аварийное отключение линии производится при выходе тока или температуры за заданные пределы. Функции аварийного отключения по превышению допустимого тока и температуры
могут быть независимо деактивированы, в таком случае аварийное отключение по превышению параметром предела не выполняется. 
.. attention::
   Функция аварийного отключения по превышению температуры учитывает температуру датчиков, но не расчитаную температуру процесса
После срабатывания функции ввод линии в работу возможен только после квитирования пользователем, либо после вывода/ввода линии в/из работы.

Индикация ошибок
---------------------------

При обнаружении ошибок устройство выставляет соответствующий флаг. 
Так же, при наличии, будет включено реле внешней индикации ошибок и/или световой индикатор.

.. note::
   При снятии ошибочного состояния флаг соответствующей ошибки снимается с задержкой, задаваемой пользователем. 
   То же самое касается и реле/индикатора ошибки.

В словаре устройства отображаются следующие ошибки:

#. Ошибки, связанные с температурой, см.  :ref:`subtable5802`

   * Ошибки расчёта температуры процесса
   * Ошибки датчиков температуры
   * Выход температур за пределы уставок

#. Ошибки связанные с током, см.  :ref:`subtable5803`

   * Выход тока нагрузки за пределы уставок
   * Наличие тока утечки
   * Наличие тока при отключенной линии
#. Остальные ошибки, см.  :ref:`subtable5806`

   * Неправильная настройка устройства
   * При наличии дискретного ввода - ошибки, связанные с внешними коммутационными устройствами(контакторы, автоматы)

Настройка линии 
--------------------
В словаре устройства настройки разделены на следующие категории:

* основные настройки(см.  :ref:`subtable5821`)
  
  * ввод линии в работу
  * выбор режима
  * параметры режимов
  * выбор безопасного режима в случае ошибок
  * стартовая задержка
  * разрешение работы при частичном отказе датчиков температуры

* настройки аварийных пределов температуры(см.  :ref:`subtable5822`)
* настройки аварийных пределов тока(см. :ref:`subtable5823`)
* дополнительные настройки
* настройки, связанные с подключением датчиков и сигналов
